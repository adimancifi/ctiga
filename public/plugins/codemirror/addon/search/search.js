(function(f){"object"==typeof exports&&"object"==typeof module?f(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],f):f(CodeMirror)})(function(f){function z(a,b){"string"==typeof a?a=new RegExp(a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),b?"gi":"g"):a.global||(a=new RegExp(a.source,a.ignoreCase?"gi":"g"));return{token:function(b){a.lastIndex=b.pos;var c=a.exec(b.string);if(c&&c.index==b.pos)return b.pos+=c[0].length||1,"searching";c?b.pos=c.index:b.skipToEnd()}}}function A(){this.overlay=this.posFrom=this.posTo=this.lastQuery=this.query=null}function k(a){return a.state.search||(a.state.search=new A)}function n(a){return"string"==typeof a&&a==a.toLowerCase()}function l(a,b,e){return a.getSearchCursor(b,e,{caseFold:n(b),multiline:!0})}function B(a,b,e,c,d){a.openDialog(b,c,{value:e,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){m(a)},onKeyDown:d})}function r(a,b,e,c,d){a.openDialog?a.openDialog(b,d,{value:c,selectValueOnOpen:!0}):d(prompt(e,c))}function C(a,b,e,c){if(a.openConfirm)a.openConfirm(b,c);else if(confirm(e))c[0]()}function u(a){return a.replace(/\\(.)/g,function(a,e){return"n"==e?"\n":"r"==e?"\r":e})}function v(a){var b=a.match(/^\/(.*)\/([a-z]*)$/);if(b)try{a=new RegExp(b[1],-1==b[2].indexOf("i")?"":"i")}catch(e){}else a=u(a);if("string"==typeof a?""==a:a.test(""))a=/x^/;return a}function p(a,b,e){b.queryText=e;b.query=v(e);a.removeOverlay(b.overlay,n(b.query));b.overlay=z(b.query,n(b.query));a.addOverlay(b.overlay);a.showMatchesOnScrollbar&&(b.annotate&&(b.annotate.clear(),b.annotate=null),b.annotate=a.showMatchesOnScrollbar(b.query,n(b.query)))}function g(a,b,e,c){var d=k(a);if(d.query)return q(a,b);var h=a.getSelection()||d.lastQuery;h instanceof RegExp&&"x^"==h.source&&(h=null);if(e&&a.openDialog){var t=null,g=function(b,c){f.e_stop(c);b&&(b!=d.queryText&&(p(a,d,b),d.posFrom=d.posTo=a.getCursor()),t&&(t.style.opacity=1),q(a,c.shiftKey,function(b,d){var c;3>d.line&&document.querySelector&&(c=a.display.wrapper.querySelector(".CodeMirror-dialog"))&&c.getBoundingClientRect().bottom-4>a.cursorCoords(d,"window").top&&((t=c).style.opacity=.4)}))};B(a,w(a),h,g,function(b,d){var c=f.keyName(b),e=a.getOption("extraKeys");c=e&&e[c]||f.keyMap[a.getOption("keyMap")][c];if("findNext"==c||"findPrev"==c||"findPersistentNext"==c||"findPersistentPrev"==c)f.e_stop(b),p(a,k(a),d),a.execCommand(c);else if("find"==c||"findPersistent"==c)f.e_stop(b),g(d,b)});c&&h&&(p(a,d,h),q(a,b))}else r(a,w(a),"Search for:",h,function(c){c&&!d.query&&a.operation(function(){p(a,d,c);d.posFrom=d.posTo=a.getCursor();q(a,b)})})}function q(a,b,e){a.operation(function(){var c=k(a),d=l(a,c.query,b?c.posFrom:c.posTo);if(!d.find(b)&&(d=l(a,c.query,b?f.Pos(a.lastLine()):f.Pos(a.firstLine(),0)),!d.find(b)))return;a.setSelection(d.from(),d.to());a.scrollIntoView({from:d.from(),to:d.to()},20);c.posFrom=d.from();c.posTo=d.to();e&&e(d.from(),d.to())})}function m(a){a.operation(function(){var b=k(a);if(b.lastQuery=b.query)b.query=b.queryText=null,a.removeOverlay(b.overlay),b.annotate&&(b.annotate.clear(),b.annotate=null)})}function w(a){return'<span class="CodeMirror-search-label">'+a.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+a.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function D(a){return'<span class="CodeMirror-search-label">'+a.phrase("Replace?")+"</span> <button>"+a.phrase("Yes")+"</button> <button>"+a.phrase("No")+"</button> <button>"+a.phrase("All")+"</button> <button>"+a.phrase("Stop")+"</button> "}function x(a,b,e){a.operation(function(){for(var c=l(a,b);c.findNext();)if("string"!=typeof b){var d=a.getRange(c.from(),c.to()).match(b);c.replace(e.replace(/\$(\d)/g,function(a,b){return d[b]}))}else c.replace(e)})}function y(a,b){if(!a.getOption("readOnly")){var e=a.getSelection()||k(a).lastQuery,c='<span class="CodeMirror-search-label">'+(b?a.phrase("Replace all:"):a.phrase("Replace:"))+"</span>";r(a,c+(' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+a.phrase("(Use /re/ syntax for regexp search)")+"</span>"),c,e,function(c){c&&(c=v(c),r(a,'<span class="CodeMirror-search-label">'+a.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',a.phrase("Replace with:"),"",function(d){d=u(d);if(b)x(a,c,d);else{m(a);var e=l(a,c,a.getCursor("from")),f=function(){var b=e.from(),h;if(!(h=e.findNext())&&(e=l(a,c),!(h=e.findNext())||b&&e.from().line==b.line&&e.from().ch==b.ch))return;a.setSelection(e.from(),e.to());a.scrollIntoView({from:e.from(),to:e.to()});C(a,D(a),a.phrase("Replace?"),[function(){g(h)},f,function(){x(a,c,d)}])},g=function(a){e.replace("string"==typeof c?d:d.replace(/\$(\d)/g,function(b,c){return a[c]}));f()};f()}}))})}}f.commands.find=function(a){m(a);g(a)};f.commands.findPersistent=function(a){m(a);g(a,!1,!0)};f.commands.findPersistentNext=function(a){g(a,!1,!0,!0)};f.commands.findPersistentPrev=function(a){g(a,!0,!0,!0)};f.commands.findNext=g;f.commands.findPrev=function(a){g(a,!0)};f.commands.clearSearch=m;f.commands.replace=y;f.commands.replaceAll=function(a){y(a,!0)}});