/**
 * Interface Elements for jQuery
 * Draggable
 *
 * http://interface.eyecon.ro
 *
 * Copyright (c) 2006 Stefan Petre
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 */
 
/**
 * Create a draggable element with a number of advanced options including callback, Google Maps type draggables,
 * reversion, ghosting, and grid dragging.
 * 
 * @name Draggable
 * @descr Creates draggable elements that can be moved across the page.
 * @param Hash hash A hash of parameters. All parameters are optional.
 * @option String handle (optional) The jQuery selector matching the handle that starts the draggable
 * @option DOMElement handle (optional) The DOM Element of the handle that starts the draggable
 * @option Boolean revert (optional) When true, on stop-drag the element returns to initial position
 * @option Boolean ghosting (optional) When true, a copy of the element is moved
 * @option Integer zIndex (optional) zIndex depth for the element while it is being dragged
 * @option Float opacity (optional) A number between 0 and 1 that indicates the opacity of the element while being dragged
 * @option Integer grid (optional) (optional) A number of pixels indicating the grid that the element should snap to
 * @option Array grid (optional) A number of x-pixels and y-pixels indicating the grid that the element should snap to
 * @option Integer fx (optional) Duration for the effect (like ghosting or revert) applied to the draggable
 * @option String containment (optional) Define the zone where the draggable can be moved. 'parent' moves it inside parent
 *                           element, while 'document' prevents it from leaving the document and forcing additional
 *                           scrolling
 * @option Array containment An 4-element array (left, top, width, height) indicating the containment of the element
 * @option String axis (optional) Set an axis: vertical (with 'vertically') or horizontal (with 'horizontally')
 * @option Function onStart (optional) Callback function triggered when the dragging starts
 * @option Function onStop (optional) Callback function triggered when the dragging stops
 * @option Function onChange (optional) Callback function triggered when the dragging stop *and* the element was moved at least
 *                          one pixel
 * @option Function onDrag (optional) Callback function triggered while the element is dragged. Receives two parameters: x and y
 *                        coordinates. You can return an object with new coordinates {x: x, y: y} so this way you can
 *                        interact with the dragging process (for instance, build your containment)
 * @option Boolean insideParent Forces the element to remain inside its parent when being dragged (like Google Maps)
 * @option Integer snapDistance (optional) The element is not moved unless it is dragged more than snapDistance. You can prevent
 *                             accidental dragging and keep regular clicking enabled (for links or form elements, 
 *                             for instance)
 * @option Object cursorAt (optional) The dragged element is moved to the cursor position with the offset specified. Accepts value
 *                        for top, left, right and bottom offset. Basically, this forces the cursor to a particular
 *                        position during the entire drag operation.
 * @option Boolean autoSize (optional) When true, the drag helper is resized to its content, instead of the dragged element's sizes
 * @option String frameClass (optional) When is set the cloned element is hidden so only a frame is dragged
 * @type jQuery
 * @cat Plugins/Interface
 * @author Stefan Petre
 */
jQuery.iDrag={helper:null,dragged:null,destroy:function(){return this.each(function(){this.isDraggable&&(this.dragCfg.dhe.unbind("mousedown",jQuery.iDrag.draginit),this.dragCfg=null,this.isDraggable=!1,jQuery.browser.msie?this.unselectable="off":(this.style.MozUserSelect="",this.style.KhtmlUserSelect="",this.style.userSelect=""))})},draginit:function(r){if(null!=jQuery.iDrag.dragged)return jQuery.iDrag.dragstop(r),!1;var g=this.dragElem;return jQuery(document).bind("mousemove",jQuery.iDrag.dragmove).bind("mouseup",jQuery.iDrag.dragstop),g.dragCfg.pointer=jQuery.iUtil.getPointer(r),g.dragCfg.currentPointer=g.dragCfg.pointer,g.dragCfg.init=!1,g.dragCfg.fromHandler=this!=this.dragElem,(jQuery.iDrag.dragged=g).dragCfg.si&&this!=this.dragElem&&(parentPos=jQuery.iUtil.getPosition(g.parentNode),sliderSize=jQuery.iUtil.getSize(g),sliderPos={x:parseInt(jQuery.css(g,"left"))||0,y:parseInt(jQuery.css(g,"top"))||0},dx=g.dragCfg.currentPointer.x-parentPos.x-sliderSize.wb/2-sliderPos.x,dy=g.dragCfg.currentPointer.y-parentPos.y-sliderSize.hb/2-sliderPos.y,jQuery.iSlider.dragmoveBy(g,[dx,dy])),jQuery.selectKeyHelper||!1},dragstart:function(r){var g=jQuery.iDrag.dragged;g.dragCfg.init=!0;var e=g.style;if(g.dragCfg.oD=jQuery.css(g,"display"),g.dragCfg.oP=jQuery.css(g,"position"),g.dragCfg.initialPosition||(g.dragCfg.initialPosition=g.dragCfg.oP),g.dragCfg.oR={x:parseInt(jQuery.css(g,"left"))||0,y:parseInt(jQuery.css(g,"top"))||0},g.dragCfg.diffX=0,g.dragCfg.diffY=0,jQuery.browser.msie){var a=jQuery.iUtil.getBorder(g,!0);g.dragCfg.diffX=a.l||0,g.dragCfg.diffY=a.t||0}g.dragCfg.oC=jQuery.extend(jQuery.iUtil.getPosition(g),jQuery.iUtil.getSize(g)),"relative"!=g.dragCfg.oP&&"absolute"!=g.dragCfg.oP&&(e.position="relative"),jQuery.iDrag.helper.empty();var t=g.cloneNode(!0);jQuery(t).css({display:"block",left:"0px",top:"0px"}),t.style.marginTop="0",t.style.marginRight="0",t.style.marginBottom="0",t.style.marginLeft="0",jQuery.iDrag.helper.append(t);var i=jQuery.iDrag.helper.get(0).style;return g.dragCfg.autoSize?(i.width="auto",i.height="auto"):(i.height=g.dragCfg.oC.hb+"px",i.width=g.dragCfg.oC.wb+"px"),i.display="block",i.marginTop="0px",i.marginRight="0px",i.marginBottom="0px",i.marginLeft="0px",jQuery.extend(g.dragCfg.oC,jQuery.iUtil.getSize(t)),g.dragCfg.cursorAt&&(g.dragCfg.cursorAt.left&&(g.dragCfg.oR.x+=g.dragCfg.pointer.x-g.dragCfg.oC.x-g.dragCfg.cursorAt.left,g.dragCfg.oC.x=g.dragCfg.pointer.x-g.dragCfg.cursorAt.left),g.dragCfg.cursorAt.top&&(g.dragCfg.oR.y+=g.dragCfg.pointer.y-g.dragCfg.oC.y-g.dragCfg.cursorAt.top,g.dragCfg.oC.y=g.dragCfg.pointer.y-g.dragCfg.cursorAt.top),g.dragCfg.cursorAt.right&&(g.dragCfg.oR.x+=g.dragCfg.pointer.x-g.dragCfg.oC.x-g.dragCfg.oC.hb+g.dragCfg.cursorAt.right,g.dragCfg.oC.x=g.dragCfg.pointer.x-g.dragCfg.oC.wb+g.dragCfg.cursorAt.right),g.dragCfg.cursorAt.bottom&&(g.dragCfg.oR.y+=g.dragCfg.pointer.y-g.dragCfg.oC.y-g.dragCfg.oC.hb+g.dragCfg.cursorAt.bottom,g.dragCfg.oC.y=g.dragCfg.pointer.y-g.dragCfg.oC.hb+g.dragCfg.cursorAt.bottom)),g.dragCfg.nx=g.dragCfg.oR.x,g.dragCfg.ny=g.dragCfg.oR.y,(g.dragCfg.insideParent||"parent"==g.dragCfg.containment)&&(parentBorders=jQuery.iUtil.getBorder(g.parentNode,!0),g.dragCfg.oC.x=g.offsetLeft+(jQuery.browser.msie?0:jQuery.browser.opera?-parentBorders.l:parentBorders.l),g.dragCfg.oC.y=g.offsetTop+(jQuery.browser.msie?0:jQuery.browser.opera?-parentBorders.t:parentBorders.t),jQuery(g.parentNode).append(jQuery.iDrag.helper.get(0))),g.dragCfg.containment&&(jQuery.iDrag.getContainment(g),g.dragCfg.onDragModifier.containment=jQuery.iDrag.fitToContainer),g.dragCfg.si&&jQuery.iSlider.modifyContainer(g),i.left=g.dragCfg.oC.x-g.dragCfg.diffX+"px",i.top=g.dragCfg.oC.y-g.dragCfg.diffY+"px",i.width=g.dragCfg.oC.wb+"px",i.height=g.dragCfg.oC.hb+"px",jQuery.iDrag.dragged.dragCfg.prot=!1,g.dragCfg.gx&&(g.dragCfg.onDragModifier.grid=jQuery.iDrag.snapToGrid),0!=g.dragCfg.zIndex&&jQuery.iDrag.helper.css("zIndex",g.dragCfg.zIndex),g.dragCfg.opacity&&(jQuery.iDrag.helper.css("opacity",g.dragCfg.opacity),window.ActiveXObject&&jQuery.iDrag.helper.css("filter","alpha(opacity="+100*g.dragCfg.opacity+")")),g.dragCfg.frameClass&&(jQuery.iDrag.helper.addClass(g.dragCfg.frameClass),jQuery.iDrag.helper.get(0).firstChild.style.display="none"),g.dragCfg.onStart&&g.dragCfg.onStart.apply(g,[t,g.dragCfg.oR.x,g.dragCfg.oR.y]),jQuery.iDrop&&0<jQuery.iDrop.count&&jQuery.iDrop.highlight(g),0==g.dragCfg.ghosting&&(e.display="none"),!1},getContainment:function(r){if(r.dragCfg.containment.constructor==String){if("parent"==r.dragCfg.containment){r.dragCfg.cont=jQuery.extend({x:0,y:0},jQuery.iUtil.getSize(r.parentNode));var g=jQuery.iUtil.getBorder(r.parentNode,!0);r.dragCfg.cont.w=r.dragCfg.cont.wb-g.l-g.r,r.dragCfg.cont.h=r.dragCfg.cont.hb-g.t-g.b}else if("document"==r.dragCfg.containment){var e=jQuery.iUtil.getClient();r.dragCfg.cont={x:0,y:0,w:e.w,h:e.h}}}else r.dragCfg.containment.constructor==Array&&(r.dragCfg.cont={x:parseInt(r.dragCfg.containment[0])||0,y:parseInt(r.dragCfg.containment[1])||0,w:parseInt(r.dragCfg.containment[2])||0,h:parseInt(r.dragCfg.containment[3])||0});r.dragCfg.cont.dx=r.dragCfg.cont.x-r.dragCfg.oC.x,r.dragCfg.cont.dy=r.dragCfg.cont.y-r.dragCfg.oC.y},hidehelper:function(r){(r.dragCfg.insideParent||"parent"==r.dragCfg.containment)&&jQuery("body",document).append(jQuery.iDrag.helper.get(0)),jQuery.iDrag.helper.empty().hide().css("opacity",1),window.ActiveXObject&&jQuery.iDrag.helper.css("filter","alpha(opacity=100)")},dragstop:function(r){if(jQuery(document).unbind("mousemove",jQuery.iDrag.dragmove).unbind("mouseup",jQuery.iDrag.dragstop),null!=jQuery.iDrag.dragged){var g=jQuery.iDrag.dragged;if(jQuery.iDrag.dragged=null,0==g.dragCfg.init)return!1;1==g.dragCfg.so&&jQuery(g).css("position",g.dragCfg.oP);g.style;if(g.si&&jQuery.iDrag.helper.css("cursor","move"),g.dragCfg.frameClass&&jQuery.iDrag.helper.removeClass(g.dragCfg.frameClass),0==g.dragCfg.revert){if(0<g.dragCfg.fx){if(!g.dragCfg.axis||"horizontally"==g.dragCfg.axis)new jQuery.fx(g,{duration:g.dragCfg.fx},"left").custom(g.dragCfg.oR.x,g.dragCfg.nRx);if(!g.dragCfg.axis||"vertically"==g.dragCfg.axis)new jQuery.fx(g,{duration:g.dragCfg.fx},"top").custom(g.dragCfg.oR.y,g.dragCfg.nRy)}else g.dragCfg.axis&&"horizontally"!=g.dragCfg.axis||(g.style.left=g.dragCfg.nRx+"px"),g.dragCfg.axis&&"vertically"!=g.dragCfg.axis||(g.style.top=g.dragCfg.nRy+"px");jQuery.iDrag.hidehelper(g),0==g.dragCfg.ghosting&&jQuery(g).css("display",g.dragCfg.oD)}else if(0<g.dragCfg.fx){var e=!(g.dragCfg.prot=!0);jQuery.iDrop&&jQuery.iSort&&g.dragCfg.so&&(e=jQuery.iUtil.getPosition(jQuery.iSort.helper.get(0))),jQuery.iDrag.helper.animate({left:e?e.x:g.dragCfg.oC.x,top:e?e.y:g.dragCfg.oC.y},g.dragCfg.fx,function(){g.dragCfg.prot=!1,0==g.dragCfg.ghosting&&(g.style.display=g.dragCfg.oD),jQuery.iDrag.hidehelper(g)})}else jQuery.iDrag.hidehelper(g),0==g.dragCfg.ghosting&&jQuery(g).css("display",g.dragCfg.oD);return jQuery.iDrop&&0<jQuery.iDrop.count&&jQuery.iDrop.checkdrop(g),jQuery.iSort&&g.dragCfg.so&&jQuery.iSort.check(g),!g.dragCfg.onChange||g.dragCfg.nRx==g.dragCfg.oR.x&&g.dragCfg.nRy==g.dragCfg.oR.y||g.dragCfg.onChange.apply(g,g.dragCfg.lastSi||[0,0,g.dragCfg.nRx,g.dragCfg.nRy]),g.dragCfg.onStop&&g.dragCfg.onStop.apply(g),!1}},snapToGrid:function(r,g,e,a){return 0!=e&&(e=parseInt((e+this.dragCfg.gx*e/Math.abs(e)/2)/this.dragCfg.gx)*this.dragCfg.gx),0!=a&&(a=parseInt((a+this.dragCfg.gy*a/Math.abs(a)/2)/this.dragCfg.gy)*this.dragCfg.gy),{dx:e,dy:a,x:0,y:0}},fitToContainer:function(r,g,e,a){return{dx:e=Math.min(Math.max(e,this.dragCfg.cont.dx),this.dragCfg.cont.w+this.dragCfg.cont.dx-this.dragCfg.oC.wb),dy:a=Math.min(Math.max(a,this.dragCfg.cont.dy),this.dragCfg.cont.h+this.dragCfg.cont.dy-this.dragCfg.oC.hb),x:0,y:0}},dragmove:function(r){if(null!=jQuery.iDrag.dragged&&1!=jQuery.iDrag.dragged.dragCfg.prot){var g=jQuery.iDrag.dragged;if(g.dragCfg.currentPointer=jQuery.iUtil.getPointer(r),0==g.dragCfg.init){if(distance=Math.sqrt(Math.pow(g.dragCfg.pointer.x-g.dragCfg.currentPointer.x,2)+Math.pow(g.dragCfg.pointer.y-g.dragCfg.currentPointer.y,2)),distance<g.dragCfg.snapDistance)return;jQuery.iDrag.dragstart(r)}var e=g.dragCfg.currentPointer.x-g.dragCfg.pointer.x,a=g.dragCfg.currentPointer.y-g.dragCfg.pointer.y;for(var t in g.dragCfg.onDragModifier){var i=g.dragCfg.onDragModifier[t].apply(g,[g.dragCfg.oR.x+e,g.dragCfg.oR.y+a,e,a]);i&&i.constructor==Object&&(e="user"!=t?i.dx:i.x-g.dragCfg.oR.x,a="user"!=t?i.dy:i.y-g.dragCfg.oR.y)}return g.dragCfg.nx=g.dragCfg.oC.x+e-g.dragCfg.diffX,g.dragCfg.ny=g.dragCfg.oC.y+a-g.dragCfg.diffY,g.dragCfg.si&&(g.dragCfg.onSlide||g.dragCfg.onChange)&&jQuery.iSlider.onSlide(g,g.dragCfg.nx,g.dragCfg.ny),g.dragCfg.onDrag&&g.dragCfg.onDrag.apply(g,[g.dragCfg.oR.x+e,g.dragCfg.oR.y+a]),g.dragCfg.axis&&"horizontally"!=g.dragCfg.axis||(g.dragCfg.nRx=g.dragCfg.oR.x+e,jQuery.iDrag.helper.get(0).style.left=g.dragCfg.nx+"px"),g.dragCfg.axis&&"vertically"!=g.dragCfg.axis||(g.dragCfg.nRy=g.dragCfg.oR.y+a,jQuery.iDrag.helper.get(0).style.top=g.dragCfg.ny+"px"),jQuery.iDrop&&0<jQuery.iDrop.count&&jQuery.iDrop.checkhover(g),!1}},build:function(e){if(!jQuery.iDrag.helper){jQuery("body",document).append('<div id="dragHelper"></div>'),jQuery.iDrag.helper=jQuery("#dragHelper");var r=jQuery.iDrag.helper.get(0),g=r.style;g.position="absolute",g.display="none",g.cursor="move",g.listStyle="none",g.overflow="hidden",window.ActiveXObject?r.unselectable="on":(g.mozUserSelect="none",g.userSelect="none",g.KhtmlUserSelect="none")}return e||(e={}),this.each(function(){if(!this.isDraggable&&jQuery.iUtil){window.ActiveXObject&&(this.onselectstart=function(){return!1},this.ondragstart=function(){return!1});var r=this,g=e.handle?jQuery(this).find(e.handle):jQuery(this);jQuery.browser.msie?g.each(function(){this.unselectable="on"}):(g.css("-moz-user-select","none"),g.css("user-select","none"),g.css("-khtml-user-select","none")),this.dragCfg={dhe:g,revert:!!e.revert,ghosting:!!e.ghosting,so:!!e.so&&e.so,si:!!e.si&&e.si,insideParent:!!e.insideParent&&e.insideParent,zIndex:!!e.zIndex&&(parseInt(e.zIndex)||0),opacity:!!e.opacity&&parseFloat(e.opacity),fx:parseInt(e.fx)||null,hpc:!!e.hpc&&e.hpc,onDragModifier:{},pointer:{},onStart:!(!e.onStart||e.onStart.constructor!=Function)&&e.onStart,onStop:!(!e.onStop||e.onStop.constructor!=Function)&&e.onStop,onChange:!(!e.onChange||e.onChange.constructor!=Function)&&e.onChange,axis:!!/vertically|horizontally/.test(e.axis)&&e.axis,snapDistance:e.snapDistance&&parseInt(e.snapDistance)||0,cursorAt:!!e.cursorAt&&e.cursorAt,autoSize:!!e.autoSize,frameClass:e.frameClass||!1},e.onDragModifier&&e.onDragModifier.constructor==Function&&(this.dragCfg.onDragModifier.user=e.onDragModifier),e.onDrag&&e.onDrag.constructor==Function&&(this.dragCfg.onDrag=e.onDrag),e.containment&&(e.containment.constructor==String&&("parent"==e.containment||"document"==e.containment)||e.containment.constructor==Array&&4==e.containment.length)&&(this.dragCfg.containment=e.containment),e.fractions&&(this.dragCfg.fractions=e.fractions),e.grid&&("number"==typeof e.grid?(this.dragCfg.gx=parseInt(e.grid)||1,this.dragCfg.gy=parseInt(e.grid)||1):2==e.grid.length&&(this.dragCfg.gx=parseInt(e.grid[0])||1,this.dragCfg.gy=parseInt(e.grid[1])||1)),e.onSlide&&e.onSlide.constructor==Function&&(this.dragCfg.onSlide=e.onSlide),this.isDraggable=!0,g.each(function(){this.dragElem=r}),g.bind("mousedown",jQuery.iDrag.draginit)}})}};

/**
 * Destroy an existing draggable on a collection of elements
 * 
 * @name DraggableDestroy
 * @descr Destroy a draggable
 * @type jQuery
 * @cat Plugins/Interface
 * @example $('#drag2').DraggableDestroy();
 */

jQuery.fn.extend(
	{
		DraggableDestroy : jQuery.iDrag.destroy,
		Draggable : jQuery.iDrag.build
	}
);