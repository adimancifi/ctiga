/**
 * 
 * Nested Sortable Plugin for jQuery/Interface.
 * 
 * Version 1.0.1
 *  
 *Change Log:
 * 1.0 
 *       Initial Release
 * 1.0.1
 *       Added noNestingClass option to prevent nesting in some elements.
 *
 *
 * Copyright (c) 2007 Bernardo de Padua dos Santos
 * Dual licensed under the MIT (MIT-LICENSE.txt) 
 * and GPL (GPL-LICENSE.txt) licenses.
 * 
 *  http://code.google.com/p/nestedsortables/
 * 
 */
jQuery.iNestedSortable={checkHover:function(e,t){return e.isNestedSortable?(jQuery.iNestedSortable.scroll(e),jQuery.iNestedSortable.newCheckHover(e)):jQuery.iNestedSortable.oldCheckHover(e,t)},oldCheckHover:jQuery.iSort.checkhover,newCheckHover:function(e){if(jQuery.iDrag.dragged&&0<e.dropCfg.el.size()){e.nestedSortCfg.remeasured||(jQuery.iSort.measure(e),e.nestedSortCfg.remeasured=!0);var t=jQuery.iNestedSortable.findPrecedingItem(e),r=jQuery.iNestedSortable.shouldNestItem(e,t),s=!t&&jQuery.iNestedSortable.isTouchingFirstItem(e),n=!1;t?e.nestedSortCfg.lastPrecedingItem===t&&e.nestedSortCfg.lastShouldNest===r&&(n=!0):e.nestedSortCfg.lastPrecedingItem===t&&e.nestedSortCfg.lastTouchingFirst===s&&(n=!0),e.nestedSortCfg.lastPrecedingItem=t,e.nestedSortCfg.lastShouldNest=r,e.nestedSortCfg.lastTouchingFirst=s,n||(null!==t?r?jQuery.iNestedSortable.nestItem(e,t):jQuery.iNestedSortable.appendItem(e,t):s&&jQuery.iNestedSortable.insertOnTop(e))}},scroll:function(e){if(!e.nestedSortCfg.autoScroll)return!1;var t=e.nestedSortCfg.scrollSensitivity,r=e.nestedSortCfg.scrollSpeed,s=jQuery.iDrag.dragged.dragCfg.currentPointer,n=jQuery.iUtil.getScroll();s.y-n.ih-n.t>-t&&window.scrollBy(0,r),s.y-n.t<t&&window.scrollBy(0,-r)},check:function(e){return jQuery.iNestedSortable.newCheck(e),jQuery.iNestedSortable.oldCheck(e)},oldCheck:jQuery.iSort.check,newCheck:function(e){jQuery.iNestedSortable.latestNestingClass&&jQuery.iNestedSortable.currentNesting&&(jQuery.iNestedSortable.currentNesting.removeClass(jQuery.iNestedSortable.latestNestingClass),jQuery.iNestedSortable.currentNesting=null,jQuery.iNestedSortable.latestNestingClass=""),jQuery.iDrop.overzone.isNestedSortable&&(jQuery.iDrop.overzone.nestedSortCfg.remeasured=!1)},serialize:function(e){return jQuery("#"+e).get(0).isNestedSortable?jQuery.iNestedSortable.newSerialize(e):jQuery.iNestedSortable.oldSerialize(e)},oldSerialize:jQuery.iSort.serialize,newSerialize:function(o){var e,l,d="",g="",t={},u=function(e){var i=[];return thisChildren=jQuery(e).children("."+jQuery.iSort.collected[o]),thisChildren.each(function(e){var t=jQuery.attr(this,"id");t&&t.match&&(t=t.match(l.nestedSortCfg.serializeRegExp)[0]),0<d.length&&(d+="&"),d+=o+g+"["+e+"][id]="+t,i[e]={id:t};var r=jQuery(this).children(l.nestedSortCfg.nestingTag+"."+l.nestedSortCfg.nestingTagClass.split(" ").join(".")).get(0),s=g;g+="["+e+"][children]";var n=u(r);0<n.length&&(i[e].children=n),g=s}),i};if(o)if(jQuery.iSort.collected[o])l=jQuery("#"+o).get(0),t[o]=u(l);else for(a in o)jQuery.iSort.collected[o[a]]&&(l=jQuery("#"+o[a]).get(0),t[o[a]]=u(l));else for(e in jQuery.iSort.collected)l=jQuery("#"+e).get(0),t[e]=u(l);return{hash:d,o:t}},findPrecedingItem:function(t){var r=0,e=jQuery.grep(t.dropCfg.el,function(e){return e.pos.y<jQuery.iDrag.dragged.dragCfg.ny&&e.pos.y>r&&((t.nestedSortCfg.rightToLeft?e.pos.x+e.pos.wb+t.nestedSortCfg.snapTolerance>jQuery.iDrag.dragged.dragCfg.nx+jQuery.iDrag.dragged.dragCfg.oC.wb:e.pos.x-t.nestedSortCfg.snapTolerance<jQuery.iDrag.dragged.dragCfg.nx)&&(!jQuery.iNestedSortable.isBeingDragged(t,e)&&(r=e.pos.y,!0)))});return 0<e.length?e[e.length-1]:null},isTouchingFirstItem:function(t){var r,e=jQuery.grep(t.dropCfg.el,function(e){return(void 0===r||e.pos.y<r)&&(!jQuery.iNestedSortable.isBeingDragged(t,e)&&(r=e.pos.y,!0))});return 0<e.length&&((e=e[e.length-1]).pos.y<jQuery.iDrag.dragged.dragCfg.ny+jQuery.iDrag.dragged.dragCfg.oC.hb&&e.pos.y>jQuery.iDrag.dragged.dragCfg.ny)},isBeingDragged:function(e,t){var r=jQuery.iDrag.dragged;return!!r&&(t==r||0!==jQuery(t).parents("."+e.sortCfg.accept.split(" ").join(".")).filter(function(){return this==r}).length)},shouldNestItem:function(e,t){return!!t&&((!e.nestedSortCfg.noNestingClass||jQuery(t).filter("."+e.nestedSortCfg.noNestingClass).get(0)!==t)&&(e.nestedSortCfg.rightToLeft?t.pos.x+t.pos.wb-(e.nestedSortCfg.nestingPxSpace-e.nestedSortCfg.snapTolerance)>jQuery.iDrag.dragged.dragCfg.nx+jQuery.iDrag.dragged.dragCfg.oC.wb:t.pos.x+(e.nestedSortCfg.nestingPxSpace-e.nestedSortCfg.snapTolerance)<jQuery.iDrag.dragged.dragCfg.nx))},nestItem:function(e,t){var r=jQuery(t).children(e.nestedSortCfg.nestingTag+"."+e.nestedSortCfg.nestingTagClass.split(" ").join(".")),s=jQuery.iSort.helper;if(styleHelper=s.get(0).style,styleHelper.width="auto",!r.size()){var n="<"+e.nestedSortCfg.nestingTag+" class='"+e.nestedSortCfg.nestingTagClass+"'></"+e.nestedSortCfg.nestingTag+">";r=jQuery(t).append(n).children(e.nestedSortCfg.nestingTag).css(e.nestedSortCfg.styleToAttach)}jQuery.iNestedSortable.updateCurrentNestingClass(e,r),jQuery.iNestedSortable.beforeHelperRemove(e),r.prepend(s.get(0)),jQuery.iNestedSortable.afterHelperInsert(e)},appendItem:function(e,t){jQuery.iNestedSortable.updateCurrentNestingClass(e,jQuery(t).parent()),jQuery.iNestedSortable.beforeHelperRemove(e),jQuery(t).after(jQuery.iSort.helper.get(0)),jQuery.iNestedSortable.afterHelperInsert(e)},insertOnTop:function(e){jQuery.iNestedSortable.updateCurrentNestingClass(e,e),jQuery.iNestedSortable.beforeHelperRemove(e),jQuery(e).prepend(jQuery.iSort.helper.get(0)),jQuery.iNestedSortable.afterHelperInsert(e)},beforeHelperRemove:function(e){var t=jQuery.iSort.helper.parent(e.nestedSortCfg.nestingTag+"."+e.nestedSortCfg.nestingTagClass.split(" ").join("."));0===t.children("."+e.sortCfg.accept.split(" ").join(".")+":visible").size()&&t.get(0)!==e&&t.hide()},afterHelperInsert:function(e){var t=jQuery.iSort.helper.parent();t.get(0)!==e&&t.show(),e.nestedSortCfg.remeasured=!1},updateCurrentNestingClass:function(e,t){var r=jQuery(t);!e.nestedSortCfg.currentNestingClass||jQuery.iNestedSortable.currentNesting&&r.get(0)==jQuery.iNestedSortable.currentNesting.get(0)||(jQuery.iNestedSortable.currentNesting&&jQuery.iNestedSortable.currentNesting.removeClass(e.nestedSortCfg.currentNestingClass),r.get(0)!=e?((jQuery.iNestedSortable.currentNesting=r).addClass(e.nestedSortCfg.currentNestingClass),jQuery.iNestedSortable.latestNestingClass=e.nestedSortCfg.currentNestingClass):(jQuery.iNestedSortable.currentNesting=null,jQuery.iNestedSortable.latestNestingClass=""))},destroy:function(){return this.each(function(){this.isNestedSortable&&(this.nestedSortCfg=null,this.isNestedSortable=null,jQuery(this).SortableDestroy())})},build:function(e){return e.accept&&jQuery.iUtil&&jQuery.iDrag&&jQuery.iDrop&&jQuery.iSort&&(this.each(function(){this.isNestedSortable=!0,this.nestedSortCfg={noNestingClass:!!e.noNestingClass&&e.noNestingClass,rightToLeft:!!e.rightToLeft,nestingPxSpace:parseInt(e.nestingPxSpace,10)||30,currentNestingClass:e.currentNestingClass?e.currentNestingClass:"",nestingLimit:!!e.nestingLimit&&e.nestingLimit,autoScroll:void 0===e.autoScroll||1==e.autoScroll,scrollSensitivity:e.scrollSensitivity?e.scrollSensitivity:20,scrollSpeed:e.scrollSpeed?e.scrollSpeed:20,serializeRegExp:e.serializeRegExp?e.serializeRegExp:/[^\-]*$/},this.nestedSortCfg.snapTolerance=parseInt(.4*this.nestedSortCfg.nestingPxSpace,10),this.nestedSortCfg.nestingTag=this.tagName,this.nestedSortCfg.nestingTagClass=this.className,this.nestedSortCfg.styleToAttach=this.nestedSortCfg.rightToLeft?{"padding-left":0,"padding-right":this.nestedSortCfg.nestingPxSpace+"px"}:{"padding-left":this.nestedSortCfg.nestingPxSpace+"px","padding-right":0},jQuery(this.nestedSortCfg.nestingTag,this).css(this.nestedSortCfg.styleToAttach)}),jQuery.iSort.checkhover=jQuery.iNestedSortable.checkHover,jQuery.iSort.check=jQuery.iNestedSortable.check,jQuery.iSort.serialize=jQuery.iNestedSortable.serialize),this.Sortable(e)}},jQuery.fn.extend({NestedSortable:jQuery.iNestedSortable.build,NestedSortableDestroy:jQuery.iNestedSortable.destroy}),jQuery.iUtil.getScroll=function(e){var t,r,s,n,i,o;return e&&"body"!=e.nodeName.toLowerCase()?(t=e.scrollTop,r=e.scrollLeft,s=e.scrollWidth,n=e.scrollHeight,o=i=0):(document.documentElement&&document.documentElement.scrollTop?(t=document.documentElement.scrollTop,r=document.documentElement.scrollLeft,s=document.documentElement.scrollWidth,n=document.documentElement.scrollHeight):document.body&&(t=document.body.scrollTop,r=document.body.scrollLeft,s=document.body.scrollWidth,n=document.body.scrollHeight),i=self.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0,o=self.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0),{t:t,l:r,w:s,h:n,iw:i,ih:o}};

//Extends jQuery to add the plugin.
jQuery.fn.extend({NestedSortable:jQuery.iNestedSortable.build,NestedSortableDestroy:jQuery.iNestedSortable.destroy});

//Monkey patches interface with some corrections, which are not applied to
//the 1.2 version yet. getScroll is needed by the autoScroll option.
jQuery.iUtil.getScroll=function(e){var t,o,l,n,c,d;return e&&"body"!=e.nodeName.toLowerCase()?(t=e.scrollTop,o=e.scrollLeft,l=e.scrollWidth,n=e.scrollHeight,d=c=0):(document.documentElement&&document.documentElement.scrollTop?(t=document.documentElement.scrollTop,o=document.documentElement.scrollLeft,l=document.documentElement.scrollWidth,n=document.documentElement.scrollHeight):document.body&&(t=document.body.scrollTop,o=document.body.scrollLeft,l=document.body.scrollWidth,n=document.body.scrollHeight),c=self.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0,d=self.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0),{t:t,l:o,w:l,h:n,iw:c,ih:d}};
